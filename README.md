# Silmaril

MUD-клиент для игры на сервере adan.ru с использованием кастомного протокола.

![Screenshot of the program](./docs/screenshot.png)

## Возможности
Помимо стандартных возможностей mud-клиентов (триггеры, алиасы), можно отметить:

* DSL-скрипты на Kotlin
* А* патфайндинг в любую зону/клетку мира
* Комбинированное отображение всех "окон" на карте
* Интеграция лоров в магазин, аукцион, рынок
* Два скина: классический и современный
* Кросс-платформенность (не нативная; через JVM)

## Установка
Если вы играли на AMC, вам понадобится перенести лоры и информацию об открытых клетках карты, а также ваши записи на картах.
1. Запустите программу.
2. В меню нажмите "Импортировать карты из AMC".
<img src="docs/img.png" alt="img" width="290">
3. Вручную перенесите лоры из `Documents\Adan client\Stuff` в `Documents\Silmaril\lores`

Проверьте, что перенесенные лоры работают, набрав **#lore хоббитский** или другой предмет.

> [!NOTE]  
> На macOS и linux, Silmaril будет пытаться стянуть карты из `~/Documents/Adan client/Maps/ZoneVizits`
> 
> Положите карты по этому пути перед импортированием.
> 
> Переносить лоры вам понадобится в путь `~/Documents/Silmaril/lores`

> [!TIP]  
> Лоры Silmaril – обратно-совместимы с AMC. Вы можете свободно переносить файлы туда и обратно.

## Новый функционал

### Карта
На карте видны все ваши окна:

<img src="docs/map1.png" alt="img" width="259">

В данном примере один из ваших персонажей – на севере от вас, а другой – на западе. 

Верхняя цифра рядом с клеткой указывает кол-во ваших согруппников в клетке. Нижняя – мобов.

Предупреждающая иконка указывает на то, что один из ваших персонажей – в бою.

Все этажи зон автоматически объединяются, например так выглядят пещеры гоблинов:

<img src="docs/map2.png" alt="img" width="893">

Кастомный цвет клетки, иконки и комментарии переносятся из АМС, но пока что нет возможности редактировать эту информацию.

Двойной клик по клетке включит бег к этой клетке.

Команда `#previewZone имя локации` откроет карту желаемой локации. Чтобы её выключить - переместитесь на любую соседнюю клетку.

### Поиск путей

В клиент встроен поиск путей. Чтобы перейти в любую зону мира из любой клетки мира, наберите `#path имя зоны`. Новичкам это должно помочь с квестингом, а опытным игрокам сэкономить время на составлении спидвоков.
Также, можно набрать `#path айди комнаты`.

Чтобы выключить путь, наберите `#path -1`.

### HP

Виджет группы показывает ХП вместо процентов. Чтобы виджет узнал ваши хп, набирет "счет" в игре своими персонажами.

Чтобы видеть хп других согруппников, им нужно написать "сост". Для петов, напишите "животное".

<img src="docs/hp.png" alt="img" width="316">

### Интеграция лоров в аукцион/магазин/рынок
Предметы в этих системах превращены в кликабельные ссылки, открывающие подсказку с лором. Лоры берутся из вашей базы предметов. В дальнейшем планируется обращаться к телеграмм-боту.

<img src="docs/lores1.png" alt="img" width="802">

### Скины

По-умолчанию клиент стартует с современным скином и шрифтами. В нем немного улучшены цветовые решения, напр. до/после:
<img src="docs/colors1.png" alt="img" width="678">

Если вам необходим визуальный стиль AMC, вы можете его вернуть в меню `Цветовая Тема -> ClassicBlack`.
Также, для получения "старого" шрифта, выберите `Шрифт -> Consolas`.

### Логгирование
В Silmaril логгирование идет всегда. Логи лежат в `Documents\Silmaril\logs`

## Как пользоваться

#### Профиль
Концепт профиля в Сильмариле немного отличается от привычного. Здесь профиль - это только _**список**_ включенных групп и вариаблы.

Таким образом, в профиле "маг" и "прист" можно включить группу "кастер", получив общие триггеры/алиасы/хоткеи для всех кастеров.

Открывая новое окно, вам будет предложено создать профиль. Профиль не может быть открыт несколько раз, профиль это и есть одно отдельное окно.

Вы можете создавать и удалять профили сколько-угодно. При удалении профиля, все алиасы/триггеры/итп сохраняются в своих группах.

#### Группы
Создав профиль, включите интересующие вас группы командой:
```
#group enable {название группы} -- скобки опциональны для групп из 1 слова
```
Наберите **#groups** чтобы посмотреть список включенных/доступных.

<img src="docs/groups.png" alt="img" width="347">

#### Триггеры

Есть две команды для создания триггеров: **#act** и **#grep**.

**#act** создаёт триггер, привычный для пользователей AMC и JMC, с возможностью вставлять (^) в начало и ($) в конец, а также использовать паттерны типа (%0).

Синтаксис:

```
#act {условие} {команда} {приоритет} {название группы} -- приоритет и группа опциональны
```
> [!IMPORTANT]  
> При неуказании группы, триггер будет записан в группу SESSION. Эта группа уникальна тем, что она:
> 1. Не сохраняется.
> 2. Существует не для всех профилей, а только для одного.
> 
> Неуказание группы говорит о том, что это временный триггер!

> [!NOTE]  
> Учтите, что добавив триггер, например, в группу "кастер", все остальные открытые с этой включенной группой также сразу получат этот триггер.

Пример использования:
```
#act {^Там было %0 мон%1.} {разделить %0} {финансы}
```

**#grep** создает точно такой же триггер, но в регексом. При этом, в "действии" также можно использовать %0, %1 для групп, которые будут захвачены регексом.
Например:
```
#grep {^Там было (\d+) мон(.*)} {разделить %0} {финансы}
```

### Алиасы

### Замены

### Хоткеи

## DSL-скрипты

## Компиляция

> [!TIP]
> Этот раздел – для разработчиков. Пользовательские инструкции – ниже.
 
Программа написана на Kotlin Compose, в большинстве кода использует Material. Однако для кастомного тайтл бара, был использован [Jewel](https://github.com/JetBrains/intellij-community/tree/master/platform/jewel). 

> [!IMPORTANT]
> Из-за Jewel, компиляция возможна только на [JBR](https://github.com/JetBrains/JetBrainsRuntime/releases) (21.0.8), т.к. обычная JDK не экспоузит манипуляцию тайтл баром.

> [!IMPORTANT]
> DSL-скрипты корректно распознаются только в [IntelliJ IDEA 2025.1.4.1 (Ultimate Edition)](https://www.jetbrains.com/idea/download/other.html)

Автор не является экспертом в Kotlin, поэтому некоторые инструкции могут быть необязательными. 

*   Установите [JBR](https://github.com/JetBrains/JetBrainsRuntime/releases), чтобы `where java` в консоли указывала на JBR.
*   Откройте проект в [IntelliJ IDEA](https://www.jetbrains.com/idea/download/other.html)
*   После инициализации gradle, запустите gradle-таск `generateResourceAccessorsForMain` (меню gradle находится с правой стороны IDE)
*   Используйте таск `run` для запуска в IDE; таск `createReleaseDistributable` для портабельной сборки.

Опционально:
*   Чтобы IDE корректно работала с DSL скриптами, зайдите в File -> Settings -> Editor -> Languages & Framework -> Kotlin -> Kotlin Scripting и нажмите **Scan Classpath**. После перезапуска, в списке должен появиться MudScriptHost (.mud.kts). Отсортируйте его, чтобы он стал предпоследним в списке.
*   Сделайте junction `mklink /J "<путь к проекту>\src\main\resources\dsl" "C:\Users\<имя пользователя>\Documents\Silmaril\dsl"`. Таким образом, DSL-скрипты будут как будто лежать в проекте, получая авто-комплит и подсветку синтаксиса в IDE.

### Знакомство с кодовой базой
* Проект использует архитектуру MVVM, поэтому почти все Composable лежат в папке `view`, модели в `model`, а прокладки между ними в `viewmodel`.
* Используется библиотека Koin для Dependency Injection. Все factory лежат в `Modules.kt`
* Логгирование настраивается в `\src\main\resources\logback.xml` - это библиотека logback.
* Каждое игровое окно - это модель `Profile`. У него есть свой `MudConnection`, `ScriptingEngine`, `MainViewModel`, `MapViewModel`, `GroupModel`, `MobsModel`, т.е. все модели, принадлежащие одному персонажу.
* В `Main` создаются окна `MainWindow`, `MapWindow`, `GroupWindow`, `MobsWindow`, `OutputWindow`, а при переключении окна, в них скармливается другой `Profile`.
* Код еще не очень хорошо рефакторнут, напр. есть god-class `Profile`, который следовало бы разобрать. Там сейчас обрабатываются все текстовые команды, вместо отдельного менеджера.